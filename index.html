<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kuantum Labirenti</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Exo+2:wght@300;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- RENK VE STİL AYARLARI --- */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.25);
            --accent-blue: #00d2ff;
            --accent-purple: #9d50bb;
            --danger: #ff4b2b;
            --success: #00f260;
            --text: #ffffff;
            --bg-deep: #020617;
            --font-main: 'Exo 2', sans-serif;
            --font-game: 'Orbitron', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: none; }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: var(--bg-deep);
            color: var(--text); font-family: var(--font-main);
        }

        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            box-shadow: 0 4px 24px 0 rgba(0, 0, 0, 0.5);
        }

        #orientation-warning {
            position: fixed; inset: 0; z-index: 9999;
            background: var(--bg-deep);
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center; padding: 20px;
        }

        @media screen and (orientation: portrait) {
            #orientation-warning { display: flex; }
        }

        .rotate-icon {
            width: 80px; height: 80px;
            border: 4px solid var(--accent-blue);
            border-radius: 12px;
            margin-bottom: 20px;
            animation: rotateAnim 2s infinite ease-in-out;
            position: relative;
        }

        @keyframes rotateAnim {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
            100% { transform: rotate(0deg); }
        }

        /* --- UI PANELLERİ --- */
        #game-ui {
            position: absolute; inset: 0;
            pointer-events: none; z-index: 100;
        }

        #game-ui > * { pointer-events: auto; }

        .top-bar {
            position: absolute; top: 15px; left: 50%;
            transform: translateX(-50%);
            display: flex; gap: 15px; padding: 10px 20px;
            width: 90%; max-width: 800px; justify-content: space-around;
        }

        .stat-item { text-align: center; }
        .stat-label { 
            display: block; font-family: var(--font-game); 
            font-size: 9px; color: var(--accent-blue);
            letter-spacing: 1px; margin-bottom: 2px;
        }
        .stat-value { font-family: var(--font-game); font-size: 16px; font-weight: bold; }

        .control-group {
            position: absolute; bottom: 20px; left: 20px;
            display: flex; gap: 10px; padding: 8px;
        }

        .icon-btn {
            width: 50px; height: 50px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.3s; border-radius: 12px;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-3px); }
        .icon-btn svg { width: 28px; height: 28px; fill: white; }

        .level-hint {
            position: absolute; bottom: 20px; right: 20px;
            padding: 10px 20px; text-align: right;
            font-family: var(--font-game); font-size: 11px;
        }

        .zoom-info {
            position: absolute; bottom: 65px; right: 20px;
            padding: 8px 15px; text-align: right;
            font-family: var(--font-game); font-size: 8px;
            color: var(--accent-blue); opacity: 0.9;
            letter-spacing: 1px; pointer-events: none;
            line-height: 1.4;
        }

        #level-splash {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200; pointer-events: none;
            text-align: center; display: none;
            padding: 15px 45px;
        }
        #level-splash h1 {
            font-family: var(--font-game);
            font-size: 28px; color: var(--accent-blue);
            margin: 0; text-transform: uppercase;
            letter-spacing: 5px; text-shadow: 0 0 15px var(--accent-blue);
        }

        .modal-overlay {
            position: fixed; inset: 0; z-index: 1000;
            background: rgba(0,0,0,0.85);
            display: flex; align-items: center; justify-content: center;
            padding: 20px;
        }

        .modal-content {
            width: 100%; max-width: 550px; padding: 30px;
            max-height: 90vh; overflow-y: auto;
            text-align: center;
        }

        h2 { font-family: var(--font-game); color: var(--accent-blue); margin-top: 0; }
        .modal-body { margin: 20px 0; line-height: 1.5; text-align: left; font-size: 14px; }
        
        .modal-actions {
            display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;
        }

        .btn-action {
            background: linear-gradient(45deg, var(--accent-blue), var(--accent-purple));
            border: none; color: white; padding: 12px 30px;
            font-family: var(--font-game); font-weight: bold;
            border-radius: 30px; cursor: pointer; transition: 0.3s;
            text-transform: uppercase;
        }
        .btn-action.secondary { background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); }
        .btn-action:hover { transform: scale(1.05); box-shadow: 0 0 20px var(--accent-blue); }

        #game-container { width: 100%; height: 100%; }
    </style>
</head>
<body>

    <div id="orientation-warning">
        <div class="rotate-icon"></div>
        <h2 style="color: white;">LÜTFEN CİHAZI YATAY ÇEVİRİN</h2>
        <p>Labirentin kapıları dikey modda açılamaz.</p>
    </div>

    <div id="level-splash" class="glass">
        <h1 id="splash-text">SEVİYE 1</h1>
    </div>

    <div id="game-ui">
        <div class="top-bar glass">
            <div class="stat-item">
                <span class="stat-label">SEVİYE</span>
                <span id="ui-level" class="stat-value">1 / 25</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">SÜRE</span>
                <span id="ui-timer" class="stat-value">00:00</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">MALİYET</span>
                <span id="ui-cost" class="stat-value">0 / 100</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">PUAN</span>
                <span id="ui-score" class="stat-value">0</span>
            </div>
        </div>

        <div class="control-group glass">
            <div class="icon-btn" id="btn-restart" title="Yeniden Başlat">
                <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
            </div>
            <div class="icon-btn" id="btn-music" title="Müzik">
                <svg id="icon-music-on" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                <svg id="icon-music-off" style="display:none;" viewBox="0 0 24 24"><path d="M4.27 3L3 4.27l9 9v.28c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4v-1.73l4 4L20.27 21 21 19.73 4.27 3zM14 7h4V3h-6v5.18l2 2V7z"/></svg>
            </div>
        </div>

        <div class="zoom-info glass">
            KONTROLLER:<br>
            DÖNDÜR: SÜRÜKLE<br>
            ZOOM: PARMAK / TEKERLEK<br>
            SEÇ: DÜĞMEYE DOKUN
        </div>

        <div class="level-hint glass" id="level-mission">
            GİRİŞ: <span id="start-node" style="color: var(--success);">A</span> | 
            ÇIKIŞ: <span id="target-node" style="color: var(--accent-blue);">G</span>
        </div>
    </div>

    <div id="intro-modal" class="modal-overlay">
        <div class="modal-content glass">
            <h2>KUANTUM LABİRENTİ</h2>
            <div class="modal-body">
                <p>Graf teorisiyle tasarlanmış 25 aşamalı kriz yönetimi simülasyonuna hoş geldiniz.</p>
                <ul>
                    <li><strong>Maliyet:</strong> Yollar üzerindeki rakamlar "kaynak tüketimini" temsil eder.</li>
                    <li><strong>Zorluk:</strong> Merkeze yakın yollar ekonomik, dış çeper çok pahalıdır.</li>
                    <li><strong>Dalgalanma:</strong> Her hamlede maliyetler yeniden hesaplanır.</li>
                    <li><strong>Strateji:</strong> En kısa değil, en verimli rotayı kurgulayın.</li>
                </ul>
            </div>
            <button class="btn-action" onclick="startGame()">SİSTEMİ AÇ</button>
        </div>
    </div>

    <div id="result-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content glass">
            <h2 id="result-title">GÖREV BİTTİ</h2>
            <div class="modal-body" id="result-stats"></div>
            <div class="modal-actions" id="result-actions">
                </div>
        </div>
    </div>

    <div id="game-container"></div>

    <script>
        // --- SES SİSTEMİ ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, duration, type = 'sine', vol = 0.1) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        const sounds = {
            step: () => playTone(300, 0.1, 'square', 0.03),
            win: () => { playTone(523, 0.2); setTimeout(() => playTone(783, 0.4), 100); },
            fail: () => playTone(110, 0.5, 'sawtooth', 0.1)
        };

        const music = new Audio('mp3/music.mp3'); music.loop = true;
        let isMusicPlaying = false;

        // --- OYUN DURUMU ---
        const State = {
            currentLevel: 1, maxLevels: 25, score: 0, lastLevelStartScore: 0,
            currentLevelCost: 0, maxLevelCost: 100,
            timeLeft: 60, timerInterval: null, isPlaying: false,
            nodes: [], edges: [], currentNodeId: 0, targetNodeId: 0, levelStats: [],
            zoomZ: 130
        };

        // --- THREE.JS KURULUMU ---
        let scene, camera, renderer, raycaster, mouse, stars, planets = [], meteors;
        let nodeMeshes = [], edgeMeshes = [], labelSprites = [], costLabels = [];
        let group = new THREE.Group();
        let targetRotation = { x: 0.5, y: 0.5 };
        let currentRotation = { x: 0, y: 0 };
        let isDragging = false;
        let prevMousePos = { x: 0, y: 0 };
        let lastPinchDist = 0;
        let dragStartTime = 0;

        function initThree() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x020617, 0.005);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 3000);
            camera.position.z = State.zoomZ;
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('game-container').appendChild(renderer.domElement);

            group.position.y = -5;
            scene.add(group);
            scene.add(new THREE.AmbientLight(0xffffff, 1.0));
            const sun = new THREE.DirectionalLight(0xffffff, 1.5);
            sun.position.set(20, 50, 30);
            scene.add(sun);

            // Yıldızlar
            const starGeo = new THREE.BufferGeometry();
            const starCoords = [];
            for(let i=0; i<4000; i++) starCoords.push((Math.random()-0.5)*2000, (Math.random()-0.5)*2000, (Math.random()-0.5)*2000);
            starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starCoords, 3));
            stars = new THREE.Points(starGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 1.2, transparent: true, opacity: 0.7 }));
            scene.add(stars);

            // Gezegenler
            const pColors = [0x9d50bb, 0x00d2ff, 0xff4b2b, 0xfacc15, 0x00f260];
            for(let i=0; i<6; i++) {
                const pGeo = new THREE.SphereGeometry(Math.random()*15 + 5, 32, 32);
                const pMat = new THREE.MeshStandardMaterial({ color: pColors[i%pColors.length], roughness: 0.8, metalness: 0.2 });
                const p = new THREE.Mesh(pGeo, pMat);
                p.position.set((Math.random()-0.5)*1200, (Math.random()-0.5)*1200, (Math.random()-0.5)*1200);
                scene.add(p);
                planets.push(p);
            }

            // Meteorlar / Kuyruklu Yıldızlar
            const mGeo = new THREE.BufferGeometry();
            const mCoords = [];
            for(let i=0; i<20; i++) mCoords.push((Math.random()-0.5)*1000, (Math.random()-0.5)*1000, (Math.random()-0.5)*1000);
            mGeo.setAttribute('position', new THREE.Float32BufferAttribute(mCoords, 3));
            meteors = new THREE.Points(mGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 2, transparent: true, opacity: 0.9 }));
            scene.add(meteors);

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            const down = (e) => { 
                isDragging = true; 
                dragStartTime = Date.now();
                const input = e.touches ? e.touches[0] : e;
                prevMousePos = { x: input.clientX, y: input.clientY }; 
            };
            const up = (e) => { 
                const duration = Date.now() - dragStartTime;
                if (duration < 250 && isDragging) handleClick(e);
                isDragging = false; lastPinchDist = 0; 
            };
            
            window.addEventListener('mousedown', down);
            window.addEventListener('touchstart', down, { passive: false });
            window.addEventListener('mouseup', up);
            window.addEventListener('touchend', up);
            window.addEventListener('mousemove', handleMove);
            window.addEventListener('touchmove', handleMove, { passive: false });
            window.addEventListener('wheel', (e) => {
                State.zoomZ = Math.min(Math.max(State.zoomZ + e.deltaY * 0.15, 60), 400);
                camera.position.z = State.zoomZ;
            }, { passive: true });
            window.addEventListener('resize', onResize);
        }

        function handleMove(e) {
            if (e.touches && e.touches.length === 2) {
                const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                if (lastPinchDist > 0) {
                    const delta = lastPinchDist - dist;
                    State.zoomZ = Math.min(Math.max(State.zoomZ + delta * 0.5, 60), 400);
                    camera.position.z = State.zoomZ;
                }
                lastPinchDist = dist;
                return;
            }
            const input = e.touches ? e.touches[0] : e;
            if (isDragging) {
                targetRotation.y += (input.clientX - prevMousePos.x) * 0.005;
                targetRotation.x += (input.clientY - prevMousePos.y) * 0.005;
                prevMousePos = { x: input.clientX, y: input.clientY };
                if (e.cancelable) e.preventDefault();
            }
            mouse.x = (input.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(input.clientY / window.innerHeight) * 2 + 1;
        }

        function handleClick(e) {
            if (!State.isPlaying) return;
            const input = (e.changedTouches && e.changedTouches.length > 0) ? e.changedTouches[0] : e;
            mouse.x = (input.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(input.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const hits = raycaster.intersectObjects(nodeMeshes);
            if (hits.length > 0) tryMove(hits[0].object.userData.id);
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function createCostSprite(text) {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.beginPath(); ctx.arc(64, 64, 45, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(0,0,0,0.6)'; ctx.fill();
            ctx.strokeStyle = 'rgba(255,255,255,0.4)'; ctx.lineWidth = 4; ctx.stroke();
            ctx.fillStyle = 'white'; ctx.font = 'bold 50px Orbitron';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(text, 64, 64);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas), depthTest: false, transparent: true, opacity: 1.0 }));
            sprite.scale.set(10, 10, 1);
            sprite.renderOrder = 999;
            return sprite;
        }

        function generateLevel(levelNum) {
            group.clear(); nodeMeshes = []; edgeMeshes = []; costLabels = [];
            State.nodes = []; State.edges = []; State.currentLevelCost = 0;
            const nodeCount = 8 + levelNum * 2;
            const radius = 40 + levelNum * 2;
            State.maxLevelCost = 50 + (levelNum * 10);
            State.timeLeft = Math.max(15, 90 - (levelNum * 2));
            for (let i = 0; i < nodeCount; i++) {
                const phi = Math.acos(-1 + (2 * i) / nodeCount);
                const theta = Math.sqrt(nodeCount * Math.PI) * phi;
                const radialFactor = i > 0 && i < nodeCount - 1 ? (0.2 + Math.random() * 0.8) : 1;
                State.nodes.push({ id: i, pos: new THREE.Vector3(radius * Math.cos(theta) * Math.sin(phi) * radialFactor, radius * Math.sin(theta) * Math.sin(phi) * radialFactor, radius * Math.cos(phi) * radialFactor) });
            }
            for (let i = 0; i < nodeCount; i++) {
                const dists = State.nodes.filter(n => n.id !== i).map(n => ({ id: n.id, d: n.pos.distanceTo(State.nodes[i].pos) })).sort((a, b) => a.d - b.d);
                for (let j = 0; j < (levelNum > 10 ? 3 : 2); j++) {
                    const tid = dists[j].id;
                    if (!State.edges.some(e => (e.from === i && e.to === tid) || (e.from === tid && e.to === i))) {
                        const avgDist = (State.nodes[i].pos.length() + State.nodes[tid].pos.length()) / 2;
                        const costMultiplier = 0.5 + (avgDist / radius); 
                        State.edges.push({ from: i, to: tid, cost: Math.floor((dists[j].d / 3) * costMultiplier) + 2 });
                    }
                }
            }
            State.currentNodeId = 0; State.targetNodeId = nodeCount - 1;
            buildVisuals(); updateUI(); updateVisualStates();
        }

        function buildVisuals() {
            const sphereGeo = new THREE.SphereGeometry(3.5, 32, 32);
            State.nodes.forEach(node => {
                const isC = node.id === State.currentNodeId, isT = node.id === State.targetNodeId;
                const mat = new THREE.MeshStandardMaterial({ color: isC ? 0x00f260 : (isT ? 0x00d2ff : 0x777777), metalness: 0.7, roughness: 0.2, emissive: isC ? 0x00f260 : (isT ? 0x00d2ff : 0x333333), emissiveIntensity: isC ? 1.2 : 0.6 });
                const mesh = new THREE.Mesh(sphereGeo, mat);
                mesh.position.copy(node.pos); mesh.userData = { id: node.id };
                group.add(mesh); nodeMeshes.push(mesh);
                if (node.id === 0 || node.id === State.targetNodeId) {
                    const canvas = document.createElement('canvas'); canvas.width = 128; canvas.height = 128;
                    const ctx = canvas.getContext('2d'); ctx.fillStyle = node.id === 0 ? '#00f260' : '#00d2ff';
                    ctx.font = 'bold 80px Orbitron'; ctx.textAlign = 'center'; ctx.fillText(node.id === 0 ? "A" : "G", 64, 90);
                    const label = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas) }));
                    label.position.copy(node.pos).y += 8; label.scale.set(15, 15, 1); group.add(label);
                }
            });
            State.edges.forEach((edge, idx) => {
                const p1 = State.nodes[edge.from].pos, p2 = State.nodes[edge.to].pos;
                const cyl = new THREE.Mesh(new THREE.CylinderGeometry(0.7, 0.7, p1.distanceTo(p2), 8), new THREE.MeshPhongMaterial({ color: 0x444444, transparent: true, opacity: 0.6 }));
                cyl.position.copy(p1).lerp(p2, 0.5); cyl.quaternion.setFromUnitVectors(new THREE.Vector3(0, 1, 0), p2.clone().sub(p1).normalize());
                group.add(cyl); edgeMeshes.push({ mesh: cyl, from: edge.from, to: edge.to });
                const cl = createCostSprite(edge.cost); cl.position.copy(cyl.position);
                group.add(cl); costLabels.push(cl);
            });
        }

        function fluctuateCosts() {
            State.edges.forEach((edge, idx) => {
                if (Math.random() > 0.7) {
                    edge.cost = Math.max(2, edge.cost + (Math.random() > 0.5 ? 2 : -2));
                    const canvas = costLabels[idx].material.map.image;
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, 128, 128);
                    ctx.beginPath(); ctx.arc(64, 64, 45, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(0,0,0,0.6)'; ctx.fill();
                    ctx.fillStyle = 'white'; ctx.fillText(edge.cost, 64, 64);
                    costLabels[idx].material.map.needsUpdate = true;
                }
            });
        }

        function tryMove(id) {
            const edge = State.edges.find(e => (e.from === State.currentNodeId && e.to === id) || (e.to === State.currentNodeId && e.from === id));
            if (edge) {
                State.currentLevelCost += edge.cost; State.currentNodeId = id; sounds.step();
                if (State.currentLevelCost > State.maxLevelCost) return gameOver("MALİYET LİMİTİ AŞILDI!");
                if (State.currentNodeId === State.targetNodeId) return levelComplete();
                fluctuateCosts(); updateVisualStates(); updateUI();
            }
        }

        function updateVisualStates() {
            nodeMeshes.forEach(m => {
                const isC = m.userData.id === State.currentNodeId, isT = m.userData.id === State.targetNodeId;
                m.material.color.setHex(isC ? 0x00f260 : (isT ? 0x00d2ff : 0x777777));
                m.material.emissiveIntensity = isC ? 1.5 : 0.6;
                m.scale.setScalar(isC ? 1.6 : 1);
            });
            edgeMeshes.forEach((e, idx) => {
                const act = e.from === State.currentNodeId || e.to === State.currentNodeId;
                e.mesh.material.opacity = act ? 0.9 : 0.25; e.mesh.material.color.setHex(act ? 0x00d2ff : 0x333333);
                if (costLabels[idx]) { costLabels[idx].material.opacity = act ? 1.0 : 0.25; costLabels[idx].scale.setScalar(act ? 10 : 7); }
            });
        }

        function startGame() { $('#intro-modal').fadeOut(); audioCtx.resume(); music.play().catch(()=>{}); isMusicPlaying = true; State.currentLevel = 1; State.score = 0; startLevel(); }
        
        function startLevel() {
            State.isPlaying = true; 
            State.lastLevelStartScore = State.score; // Seviye başı puanını kaydet
            generateLevel(State.currentLevel);
            $('#splash-text').text(`SEVİYE ${State.currentLevel}`); $('#level-splash').fadeIn(400).delay(1000).fadeOut(600);
            if (State.timerInterval) clearInterval(State.timerInterval);
            State.timerInterval = setInterval(() => { State.timeLeft--; updateUI(); if (State.timeLeft <= 0) gameOver("SÜRE DOLDU!"); }, 1000);
        }

        function retryLevel() {
            State.score = State.lastLevelStartScore; // Puanı geri çek
            $('#result-modal').hide();
            startLevel();
        }

        function levelComplete() {
            State.isPlaying = false; clearInterval(State.timerInterval); sounds.win();
            const s = Math.max(100, (State.maxLevelCost - State.currentLevelCost) * 20 + (State.timeLeft * 10));
            State.score += s; State.levelStats.push({ level: State.currentLevel, cost: State.currentLevelCost, time: State.timeLeft });
            if (State.currentLevel >= State.maxLevels) showFinalResults(); else { State.currentLevel++; setTimeout(startLevel, 800); }
        }

        function gameOver(r) { 
            State.isPlaying = false; 
            clearInterval(State.timerInterval); 
            sounds.fail(); 
            $('#result-title').text(r); 
            $('#result-stats').html(`<p>Sistem çevrimdışı. Seviye ${State.currentLevel} aşılamadı.</p><h3>Puan: ${State.score}</h3>`); 
            $('#result-actions').html(`
                <button class="btn-action" onclick="retryLevel()">TEKRAR DENE</button>
                <button class="btn-action secondary" onclick="location.reload()">SİSTEMİ SIFIRLA</button>
            `);
            $('#result-modal').fadeIn(); 
        }

        function showFinalResults() { 
            $('#result-title').text("SİSTEM TAMAMLANDI!"); 
            let h = `<h3>TOPLAM PUAN: ${State.score}</h3>`; 
            $('#result-stats').html(h); 
            $('#result-actions').html(`<button class="btn-action" onclick="location.reload()">BAŞTAN BAŞLA</button>`);
            $('#result-modal').fadeIn(); 
        }

        function updateUI() {
            $('#ui-level').text(`${State.currentLevel} / ${State.maxLevels}`); $('#ui-cost').text(`${State.currentLevelCost} / ${State.maxLevelCost}`);
            $('#ui-score').text(State.score); const m = Math.floor(State.timeLeft / 60), s = State.timeLeft % 60;
            $('#ui-timer').text(`${m}:${s.toString().padStart(2,'0')}`).css('color', State.timeLeft < 10 ? 'var(--danger)' : 'white');
        }

        function animate() {
            requestAnimationFrame(animate); 
            currentRotation.x += (targetRotation.x - currentRotation.x) * 0.08; 
            currentRotation.y += (targetRotation.y - currentRotation.y) * 0.08;
            group.rotation.set(currentRotation.x, currentRotation.y, 0); 
            
            // Animasyonlar
            stars.rotation.y += 0.0003;
            planets.forEach((p, i) => { p.rotation.y += 0.005; p.position.y += Math.sin(Date.now()*0.001 + i)*0.1; });
            
            // Meteor hareketi
            const mPos = meteors.geometry.attributes.position.array;
            for(let i=0; i<mPos.length; i+=3) {
                mPos[i] += 2; mPos[i+1] -= 1;
                if(mPos[i] > 500) { mPos[i] = -500; mPos[i+1] = Math.random()*1000 - 500; }
            }
            meteors.geometry.attributes.position.needsUpdate = true;

            const t = Date.now() * 0.0015; 
            nodeMeshes.forEach((m, i) => { if (m.userData.id === State.currentNodeId) m.position.y = State.nodes[i].pos.y + Math.sin(t * 4) * 0.8; });
            renderer.render(scene, camera);
        }

        $('#btn-restart').on('click', () => { if (confirm("Seviye baştan başlasın mı?")) startLevel(); });
        $('#btn-music').on('click', () => { isMusicPlaying ? music.pause() : music.play().catch(()=>{}); isMusicPlaying = !isMusicPlaying; $('#icon-music-on').toggle(isMusicPlaying); $('#icon-music-off').toggle(!isMusicPlaying); });
        $(document).ready(() => { initThree(); animate(); });
    </script>
</body>
</html>